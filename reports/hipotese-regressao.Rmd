---
title: "FPCC II - Lab 3, Checkpoint 1"
author: "Amanda Souza"
date: "21/05/2018"
output: html_document
---

Testes de Hipótese e Regressão: Discovery Hiring Analyst 2016
===============

### Sumário

1. Introdução
2. Respondendo as perguntas por meio de ICs
3. Conclusão

**1. What is our daily overall clickthrough rate? How does it vary between the groups?**

**H_0**: A média do grupo A é igual a média do grupo B. (Não há diferença significativa entre as médias).
$$H_0: a = b$$
**H_1**: A média do grupo A é diferente a média do grupo B. (Existe diferença significativa entre as médias).
$$H_1: a \neq b$$

**3. What is our daily overall zero results rate? How does it vary between the groups?**

**H_0**: A taxa do grupo A é igual a taxa do grupo B. (Não há diferença significativa entre as médias).
$$H_0: a = b$$
**H_1**: A taxa do grupo A é diferente a taxa do grupo B. (Existe diferença significativa entre as médias).
$$H_1: a \neq b$$
```{r message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(lubridate)
library(resample) # <-- Para bootstrap!
library(boot) # <-- Para bootstrap!

wikimedia = read_csv("/Users/amandasouza/lab2-cp4-aminueza/data/search_data.csv")
```

```{r}
#Removendo sessões duplicadas
wikimedia = wikimedia %>% 
    distinct(session_id, .keep_all = T) %>%
    filter(results >= first_click | (!is.na(num_clicks) & num_clicks == 0)) %>%
    mutate(session_start_date = round_date(session_start_date, unit = "day"))

```

```{r}
wikimedia %>%
  group_by(session_start_date, group) %>% 
  summarise(crt_day = sum((num_clicks > 0) / n()) *100) %>%
  ggplot(aes(x=session_start_date, 
               y=crt_day,
               color=group)) +
  geom_point() +
  geom_line() +
  scale_color_brewer(palette="Set1") +
  labs(title = "Overall Clicks/Searches by Groups", 
       y = "Overall by day (12 hours)",
       x = NULL) + 
  theme_classic()
```
```{r}
wikimedia %>%
    group_by(session_start_date, group) %>% 
    summarise(crt = sum(num_clicks > 0) / n()) %>%
    permutationTest2(mean(crt), 
                       treatment = group, 
                       alternative = "two.sided",
                       R = 10000)

# Bootstrap calculando a diferenca
b.diff.means = bootstrap2(wikimedia$crt, 
                          mean,
                          treatment = wikimedia$group) # 10000 amostragens por padrão

means.diff = CI.percentile(b.diff.means, probs = c(.025, .975)) #confianca de 95%
print(means.diff)
data.frame(means.diff) %>% 
  ggplot(aes(x = "Diferença", ymin = X2.5., ymax = X97.5.)) + 
  geom_errorbar(width = .2)

modelCRT <- lm(crt ~ group, data = wikimedia)
teste <- with(experimentos_finais, data.frame(crt=mean(crt)))
teste$pred <- predict(modelEval, teste, type = "response")
teste %>% kable()
```
```{r}

zero =  wikimedia %>%
  group_by(session_start_date,group) %>%
  summarise(zero = sum(results == 0),
            total = n()) %>% 
  mutate(rate = zero/total * 100) %>% 
  na.omit()

DOCR_wikimedia = wikimedia %>% 
  group_by(session_start_date, group) %>% 
  summarise(allsession = n(),
            click = sum(num_clicks > 0)
  ) %>% 
  mutate(crt = click/allsession * 100)

experimentos_finais = DOCR_wikimedia %>%
  merge(zero)



modelCRT <- lm(crt ~ zero, data = experimentos_finais)
confint(modelCRT)

teste <- with(experimentos_finais, data.frame(crt=mean(crt), zero=mean(zero)))
teste$pred <- predict(modelEval, teste, type = "response")
teste %>% kable()

#confint(modelEval)
#summary(modelEval)

ggplot(experimentos_finais, aes(x = rate, y = crt)) + 
  geom_point(alpha = 0.4) + 
  geom_line(aes(y = predict(modelCRT, experimentos_finais))) + 
  stat_smooth(method = "lm") + 
  xlab("Zero Results") + 
  ylab("Clickthrough Rate") +
  theme_classic()
```

**E qual a relação entre o clickthrough rate e os zero results**

Para explicar o efeito dos Zero Results no Clickthrough Rate, definimos o seguinte modelo:

$$Zero=B_0+B_1 \cdot crt $$

**H_0**: A média do CRT é igual a taxa do grupo B. (Não há diferença significativa entre as médias).
$$H_0: a = b$$